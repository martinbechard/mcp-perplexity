<!--
Copyright (c) 2024 Martin Bechard <martin.bechard@DevConsult.ca>
This software is licensed under the MIT License.
File: /Users/martinbechard/dev/mcp-perplexity/design/Logger.md
This was generated by Claude Sonnet 3.5, with the assistance of my human mentor

Design document for the Logger utility class and its associated types
Logs: Because printf debugging is so last century!
-->

# Table of Contents
- Type: LogMessages
- Class: Logger

---
# Type: LogMessages

## Overview 
Enum type defining all log message templates used throughout the application for consistent logging

## Design Requirements
1. MUST be implemented as a TypeScript enum for compile-time checks
   Source: TypeScript best practices for constant strings
2. MUST include messages for all major server operations and error conditions
   Source: From high-level design logging requirements
3. MUST follow consistent message format with timestamps
   Source: Based on example filesystem server implementation
4. MUST be colocated with Logger class
   Source: Current high-level design document

## Design Considerations
1. Message Format
   - WHY: Ensures consistent log message structure across the application
   - HOW: Use template literals for dynamic values when logging
   - EXAMPLE: 
     ```typescript
     TOOL_CALL_RECEIVED = "Tool call received" // Will use `` when calling logger
     ```

## Attributes
```typescript
enum LogMessages {
    SERVER_START = "Perplexity MCP Server starting",
    SERVER_READY = "Server ready and listening",
    TOOL_CALL_RECEIVED = "Tool call received",
    API_REQUEST_START = "Calling Perplexity API",
    API_RESPONSE_RECEIVED = "Received API response",
    API_ERROR = "Error calling Perplexity API",
    VALIDATION_ERROR = "Validation error",
    VALIDATION_COMPLETE = "Validation complete",
    CONFIG_ERROR = "Configuration error",
    HANDLER_SETUP = "Setting up request handlers",
    HANDLER_REGISTERED = "Handler registered",
    RESPONSE_FORMATTED = "Response formatting complete"
}
```

---
# Class: Logger

## Overview
Static utility class that handles all logging operations throughout the application, with support for debug logging and error reporting

## Design Requirements
1. MUST be implemented as a static utility class
   Source: High-level design document
2. MUST write all logs (regular and debug) to a single file at ~/Library/Logs/Claude/mcp-server-perplexity.log
   Source: System integration requirement
3. MUST maintain in-memory logs for resource handler access
   Source: Protocol requirement
4. MUST handle debug level logging controlled by flag
   Source: Debug requirements
5. MUST include timestamps with all log entries
   Source: Based on example filesystem server implementation
6. MUST handle asynchronous file operations
   Source: Node.js best practices for file operations

## Design Considerations
1. Single Log File Management
   - WHY: Provides unified logging for both regular and debug entries
   - HOW: Append all logs to mcp-server-perplexity.log
   - EXAMPLE:
     ```typescript
     await fs.appendFile(LOG_PATH, logEntry + "\n", "utf-8");
     ```

2. Debug Level Control
   - WHY: Allows detailed logging when needed without cluttering normal operation
   - HOW: Use debug flag to control additional data logging
   - EXAMPLE:
     ```typescript
     if (this.debugEnabled && data) {
         logEntry += `\n${JSON.stringify(data, null, 2)}`;
     }
     ```

3. In-Memory Cache
   - WHY: Resource handler needs quick access to recent logs
   - HOW: Maintain array of recent log entries alongside file logging
   - EXAMPLE:
     ```typescript
     this.logs.push(logEntry);
     await fs.appendFile(LOG_PATH, logEntry + "\n", "utf-8");
     ```

## Main Functions
1. trace(message: string, data?: any): Promise<void>
   - Main logging function that handles both regular and debug logging
   - Pseudocode:
     ```typescript
     - Get timestamp
     - Create base log entry with timestamp and message
     - If debug enabled and data provided, add formatted data
     - Append to log array
     - Write to log file
     - Handle any errors silently
     ```

2. error(message: string, error?: any): Promise<void>
   - Error logging function with full error details
   - Pseudocode:
     ```typescript
     - Get timestamp
     - Create error entry with timestamp and message
     - Add error details if provided
     - Append to log array
     - Write to log file
     - Handle any meta-errors silently
     ```

3. getLogContent(): string[]
   - Returns current log entries without clearing
   - Used by resource handler for log access
   - No pseudocode needed (simple getter)

4. clearLogs(): void
   - Clears the in-memory log array
   - No pseudocode needed (simple array clear)

## Attributes
```typescript
class Logger {
    private static readonly LOG_PATH: string = "/Users/martinbechard/Library/Logs/Claude/mcp-server-perplexity.log";
    private static logs: string[] = [];
    private static debugEnabled: boolean = false;
    private static initialized: boolean = false;
}
```
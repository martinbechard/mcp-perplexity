<!--
Copyright (c) 2024 Martin Bechard <martin.bechard@DevConsult.ca>
This software is licensed under the MIT License.
File: /Users/martinbechard/dev/mcp-perplexity/design/PerplexityValidator.md
This was generated by Claude Sonnet 3.5, with the assistance of my human mentor

Design document for Perplexity API validation logic
Validation: Because TypeScript types are just suggestions at runtime!
-->

# Table of Contents
- Class: PerplexityValidator

---
# Class: PerplexityValidator

## Overview
Static utility class that provides Zod schemas and validation methods for all Perplexity API related types

## Design Requirements
1. MUST be implemented as a static utility class
   Source: High-level design document
2. MUST use Zod for validation
   Source: High-level design document and custom instructions
3. MUST validate all API inputs
   Source: High-level design document
4. MUST enforce Perplexity API constraints
   Source: Perplexity API documentation

## Design Considerations
1. Schema Reusability
   - WHY: Avoid duplicating validation logic
   - HOW: Export individual schemas as static members
   - EXAMPLE:
     ```typescript
     static readonly messageSchema = z.object({
       role: z.enum(['system', 'user']),
       content: z.string().min(1)
     });
     ```

2. Error Messaging
   - WHY: Provide clear error messages for validation failures
   - HOW: Use Zod's error customization
   - EXAMPLE:
     ```typescript
     temperature: z.number()
       .min(0, "Temperature must be at least 0")
       .max(2, "Temperature must be less than 2")
       .optional()
     ```

3. Validation Method Design
   - WHY: Provide convenient validation with type inference
   - HOW: Create typed validation methods using schemas
   - EXAMPLE:
     ```typescript
     static validateConfig(config: unknown): PerplexityConfig {
       return this.configSchema.parse(config);
     }
     ```

## Main Functions

1. validateConfig(config: unknown): PerplexityConfig
   - Validates a configuration object
   - Pseudocode:
     ```typescript
     - Apply configSchema
     - Return typed config if valid
     - Throw ZodError if invalid
     ```

2. validateMessage(message: unknown): Message
   - Validates a single message
   - No pseudocode needed (simple schema application)

3. validateResponse(response: unknown): ChatCompletionResponse
   - Validates API response
   - No pseudocode needed (simple schema application)

## Attributes
```typescript
class PerplexityValidator {
    /** Schema for message validation */
    private static readonly messageSchema: z.ZodType<Message>;
    
    /** Schema for usage stats validation */
    private static readonly usageSchema: z.ZodType<Usage>;
    
    /** Schema for choice validation */
    private static readonly choiceSchema: z.ZodType<Choice>;
    
    /** Schema for API response validation */
    private static readonly responseSchema: z.ZodType<ChatCompletionResponse>;
    
    /** Schema for config validation */
    private static readonly configSchema: z.ZodType<PerplexityConfig>;
}

// Schema Definitions
private static readonly messageSchema = z.object({
    role: z.enum(['system', 'user']),
    content: z.string().min(1)
});

private static readonly usageSchema = z.object({
    promptTokens: z.number().int().nonnegative(),
    completionTokens: z.number().int().nonnegative(),
    totalTokens: z.number().int().nonnegative()
});

private static readonly choiceSchema = z.object({
    index: z.number().int().nonnegative(),
    finishReason: z.enum(['stop', 'length']),
    message: this.messageSchema,
    delta: z.object({
        role: z.string().optional(),
        content: z.string().optional()
    }).optional()
});

private static readonly responseSchema = z.object({
    id: z.string(),
    model: z.string(),
    object: z.string(),
    created: z.number().int(),
    citations: z.array(z.string().url()),
    choices: z.array(this.choiceSchema),
    usage: this.usageSchema
});

private static readonly configSchema = z.object({
    model: z.string(),
    messages: z.array(this.messageSchema),
    maxTokens: z.number().int().positive().optional(),
    temperature: z.number().min(0).max(2).optional(),
    topP: z.number().min(0).max(1).optional(),
    searchDomainFilter: z.array(z.string()).max(3).optional(),
    returnImages: z.boolean().optional(),
    returnRelatedQuestions: z.boolean().optional(),
    searchRecencyFilter: z.enum(['month', 'week', 'day', 'hour']).optional(),
    topK: z.number().int().min(0).max(2048).optional(),
    stream: z.boolean().optional(),
    presencePenalty: z.number().min(-2).max(2).optional(),
    frequencyPenalty: z.number().positive().optional()
});
```
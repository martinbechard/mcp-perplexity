<!--
Copyright (c) 2024 Martin Bechard <martin.bechard@DevConsult.ca>
This software is licensed under the MIT License.
File: /Users/martinbechard/dev/mcp-perplexity/design/chat-completion-flow.mmd
This was generated by Claude Sonnet 3.5, with the assistance of my human mentor

Flow diagram for chat completion handling
Flowcharts: Following the data from request to response!
-->

sequenceDiagram
    participant Claude as Claude
    participant Server as PerplexityServer
    participant Handler as MessageHandler
    participant Service as PerplexityService
    participant API as Perplexity API
    participant Logger as Logger
    participant Validator as Validator

    Claude->>Server: call_tool request
    Server->>Handler: Process call_tool
    Handler->>Logger: Log request
    Handler->>Validator: Validate input
    Handler->>Service: Create chat completion
    Service->>API: POST /chat/completions
    API->>Service: Response with citations
    Service->>Validator: Validate response
    Service->>Handler: Return completion
    Handler->>Server: Format MCP response
    Server->>Claude: Tool response with citations
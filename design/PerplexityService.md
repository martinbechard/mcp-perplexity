<!--
Copyright (c) 2024 Martin Bechard <martin.bechard@DevConsult.ca>
This software is licensed under the MIT License.
File: /Users/martinbechard/dev/mcp-perplexity/design/PerplexityService.md
This was generated by Claude Sonnet 3.5, with the assistance of my human mentor

Design document for the Perplexity API service
Making API calls so you don't have to!
-->

# Table of Contents
- Class: PerplexityService

---
# Class: PerplexityService

## Overview
Singleton service that handles all direct communication with the Perplexity API

## Design Requirements
1. MUST be implemented as a singleton service pattern
   Source: High-level design document
2. MUST use axios for API calls
   Source: Custom instructions and high-level design
3. MUST implement retry logic and error handling
   Source: High-level design document
4. MUST validate all inputs before sending to API
   Source: API safety best practices

## Design Considerations
1. Request Configuration
   - WHY: Ensure consistent API call setup
   - HOW: Create base axios instance with common config
   - EXAMPLE:
     ```typescript
     private readonly client = axios.create({
       baseURL: API_CONSTANTS.BASE_URL,
       timeout: API_CONSTANTS.TIMEOUT_MS,
       headers: {
         'Content-Type': 'application/json'
       }
     });
     ```

2. Error Handling
   - WHY: Provide meaningful error information
   - HOW: Wrap API errors with additional context
   - EXAMPLE:
     ```typescript
     try {
       await this.client.post('/chat/completions', data);
     } catch (error) {
       if (axios.isAxiosError(error)) {
         throw new PerplexityApiError(error);
       }
       throw error;
     }
     ```

3. Retry Strategy
   - WHY: Handle transient failures gracefully
   - HOW: Implement exponential backoff
   - EXAMPLE:
     ```typescript
     for (let attempt = 1; attempt <= API_CONSTANTS.MAX_RETRIES; attempt++) {
       try {
         return await this.makeRequest();
       } catch (error) {
         if (!this.shouldRetry(error)) throw error;
         await this.delay(attempt);
       }
     }
     ```

## Main Functions

1. async createChatCompletion(config: PerplexityConfig): Promise<ChatCompletionResponse>
   - Primary method for making chat completion requests
   - Pseudocode:
     ```typescript
     - Validate config using PerplexityValidator
     - Prepare request data
     - If retry needed
       - Execute with retry logic
     - Else
       - Make single request
     - Validate response
     - Return typed response
     ```

2. private async makeRequest(endpoint: string, data: unknown): Promise<unknown>
   - Internal method for making HTTP requests with retry logic
   - Pseudocode:
     ```typescript
     - For each retry attempt:
       - Try to make request
       - If success, return response
       - If error and should retry:
         - Wait with exponential backoff
         - Continue to next attempt
       - If error and shouldn't retry:
         - Throw error
     - If max retries exceeded:
       - Throw error
     ```

3. private shouldRetry(error: unknown): boolean
   - Determines if an error should trigger a retry
   - Pseudocode:
     ```typescript
     - If network error, return true
     - If rate limit error, return true
     - If server error (5xx), return true
     - Otherwise return false
     ```

## Attributes
```typescript
class PerplexityService {
    private static instance: PerplexityService;
    private readonly client: AxiosInstance;
    private readonly apiKey: string;

    private constructor(apiKey: string) {
        this.apiKey = apiKey;
        this.client = axios.create({
            baseURL: API_CONSTANTS.BASE_URL,
            timeout: API_CONSTANTS.TIMEOUT_MS,
            headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            }
        });
    }

    public static getInstance(apiKey: string): PerplexityService {
        if (!PerplexityService.instance) {
            PerplexityService.instance = new PerplexityService(apiKey);
        }
        return PerplexityService.instance;
    }
}
```